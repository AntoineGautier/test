name: Test


on:
  pull_request:
    branches:
      - 'master'
  push:
    branches:
      - 'master'

env:
  BUILD_TYPE: Release
  GH_USERNAME: ${{ github.actor }}

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Push Linux & macOS binaries
        if: |
          contains(matrix.os, 'latest') &&
          github.event_name == 'push' &&
          github.ref == 'refs/heads/master'
        run: |
          git config --global user.name $GH_USERNAME
          git config --global user.email $GH_USERNAME@users.noreply.github.com
          git config --global pull.rebase true
          echo $GITHUB_SHA > ${{ matrix.os }}_commit.txt
          git add ${{ github.workspace }}/${{ matrix.os }}_commit.txt

      - name: Push Linux & macOS binaries
        if: |
          (matrix.os == 'ubuntu-latest' || matrix.os == 'macos-latest') &&
          github.event_name == 'push' &&
          github.ref == 'refs/heads/master'
        run: |
          git diff-index --quiet HEAD || { git commit -m "Add ${{ matrix.os }} binaries" && git pull && git push; }

      # We use cmd /c because powershell <7 does not support chain operators.
      - name: Push Windows binaries
        if: |
          matrix.os == 'windows-latest' &&
          github.event_name == 'push' &&
          github.ref == 'refs/heads/master'
        run: |
          cmd /c 'git diff-index --quiet HEAD || ( git commit -m "Add ${{ matrix.os }} binaries" && git pull && git push )'